{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>Backtesting Engine</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Indie+Flower&display=swap" rel="stylesheet">
    <!-- Bootstrap Css -->
    <link href="{% static 'dashboard/css/bootstrap.min.css' %}" id="bootstrap-style" rel="stylesheet" type="text/css" />
    <!-- Icons Css -->
    <link href="{% static 'dashboard/css/icons.min.css' %}" rel="stylesheet" type="text/css" />
    <style>
        #page-topbar {
            background-color: #007bff; /* 蓝色背景 */
            padding: 20px 0; /* 增加高度和上下间距 */
        }
        
        .logo h2 {
            font-family: 'Indie Flower', cursive; /* 使用艺术字体 */
            color: white; /* 设置文本颜色为白色 */
            padding: 0 20px; /* 增加左右间距 */
            margin: 10px 0; /* 增加上下边距 */
            /* 设置字体大小 */
            font-size: 50px;
        }
        .tabcontent {
            display: none;
            padding: 6px 12px;
            border: 1px solid #ccc;
            border-top: none;
        }
        .tabcontent {
            animation: fadeEffect 1s; /* Fading effect takes 1 second */
        }
    </style>
</head>
<body data-layout="horizontal" data-topbar="colored">
    <!-- Begin page -->
    <div id="layout-wrapper">
        <header id="page-topbar">
            <div class="navbar-header">
                <div class="d-flex">
                    <!-- LOGO -->
                    <div class="navbar-brand-box">
                        <a href="{% url 'home' %}" class="logo logo-light" style="text-decoration: none;">
                            <span class="logo-sm">
                                {% comment %} <img src="{% static 'dashboard/images/logo-sm.png' %}" alt="" height="30"> {% endcomment %}
                                <h2 style="color: White;">Home</h2>
                            </span>
                        </a>
                    </div>
                </div>
            </div>
        </header>
        <div id="loading-indicator" class="progress mt-3" style="display: none;">
            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%"></div>
        </div>
        <div class="container mt-5">
            <h1 class="text-center">Stock Backtesting Engine</h1>
            <div class="row mt-4">
                <div class="col-md-6 offset-md-3">
                    <form id="backtesting-form" method = "POST" action = "{% url "backtesting_engine" %}">
                        {% csrf_token %}
                        <div class="form-group">
                            <label for="ticker">Stock Code:</label>
                            <input type="text" class="form-control" id="ticker" placeholder="Enter stock code">
                        </div>
                        <div class="form-group">
                            <label for="start_date">Start Date:</label>
                            <input type="date" class="form-control" id="start_date">
                        </div>
                        <div class="form-group">
                            <label for="end_date">End Date:</label>
                            <input type="date" class="form-control" id="end_date">
                        </div>
                        <div class="form-group">
                            <label for="initial_balance">Initial Funds:</label>
                            <input type="number" class="form-control" id="initial_balance" placeholder="Enter initial funds">
                        </div>
                        <div class="form-group">
                            <label for="stop_loss">Stop Loss Ratio:</label>
                            <input type="number" step="0.01" class="form-control" id="stop_loss" placeholder="Enter stop loss ratio">
                        </div>
                        <div class="form-group">
                            <label for="take_profit">Take Profit Ratio:</label>
                            <input type="number" step="0.01" class="form-control" id="take_profit" placeholder="Enter take profit ratio">
                        </div>
                        <button type="submit" class="btn btn-primary mt-3">Open Backtesting Engine</button>
                    </form>
                </div>
            </div>
            <div class="mt-5" id="investment-data" >
                <h2 class="text-center">Investment Information</h2>
                <div class="row">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <h4 class="mb-1 mt-1" style="color:#2b46f6;" id="final_balance"></h4>
                                <p class="text-muted mb-0">Final Balance</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <h4 class="mb-1 mt-1" style="color:#2b46f6;" id="beta"></h4>
                                <p class="text-muted mb-0">Beta</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <h4 class="mb-1 mt-1" style="color:#2b46f6;" id="sharpe_ratio"></h4>
                                <p class="text-muted mb-0">Sharpe Ratio</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <h4 class="mb-1 mt-1" style="color:#2b46f6;" id="alpha"></h4>
                                <p class="text-muted mb-0">Alpha</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <h4 class="mb-1 mt-1" style="color:#2b46f6;" id="total_return"></h4>
                                <p class="text-muted mb-0">Total Return</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <h4 class="mb-1 mt-1" style="color:#2b46f6;" id="sma_short_window"></h4>
                                <p class="text-muted mb-0">SMA Short Window</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <h4 class="mb-1 mt-1" style="color:#2b46f6;" id="sma_long_window"></h4>
                                <p class="text-muted mb-0">SMA Long Window</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
        <div id="plots"></div>
        <footer class="footer">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-sm-6">
                        <script>document.write(new Date().getFullYear())</script> © The fourth group
                    </div>
                    <div class="col-sm-6">
                        <div class="text-sm-right d-none d-sm-block">
                            Crafted with <i class="fas fa-heart"></i>
                        </div>
                    </div>
                </div>
            </div>
        </footer>
    </div>
    <!-- JAVASCRIPT -->
    <script src="{% static 'dashboard/libs/jquery/jquery.min.js' %}"></script>
    <script src="{% static 'dashboard/libs/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
    <script src="{% static 'dashboard/libs/metismenu/metisMenu.min.js' %}"></script>
    <script src="{% static 'dashboard/libs/simplebar/simplebar.min.js' %}"></script>
    <script src="{% static 'dashboard/libs/node-waves/waves.min.js' %}"></script>
    <script src="{% static 'dashboard/libs/waypoints/lib/jquery.waypoints.min.js' %}"></script>
    <script src="{% static 'dashboard/libs/jquery.counterup/jquery.counterup.min.js' %}"></script>

    <!-- apexcharts -->
    <script src="{% static 'dashboard/libs/apexcharts/apexcharts.min.js' %}"></script>

    <script src="{% static 'dashboard/js/pages/dashboard.init.js' %}"></script>

    <script src="{% static 'dashboard/js/app.js' %}"></script>

    <script>
        $(document).ready(function() {
            $('#backtesting-form').on('submit', function(event) {
                event.preventDefault();
                
                var ticker = $('#ticker').val();
                var start_date = $('#start_date').val();
                var end_date = $('#end_date').val();
                var initial_balance = $('#initial_balance').val();
                var stop_loss = $('#stop_loss').val();
                var take_profit = $('#take_profit').val();
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
                
              
                $('#loading-indicator').show();

                $.ajax({
                    url: '/backtesting_engine/',
                    type: 'POST',
                    headers: {'X-CSRFToken': csrfToken},  // 将 CSRF 令牌添加到请求头部
                    contentType: 'application/json',  // 确保请求是以 JSON 形式发送
                    data: JSON.stringify({
                        'ticker': ticker,
                        'start_date': start_date,
                        'end_date': end_date,
                        'initial_balance': initial_balance,
                        'stop_loss': stop_loss,
                        'take_profit': take_profit
                    }),
            
                    success: function(response) {
                        
                        $('#final_balance').text(response.final_balance);
                        $('#beta').text(response.beta);
                        $('#sharpe_ratio').text(response.sharpe_ratio);
                        $('#alpha').text(response.alpha);
                        $('#total_return').text(response.total_return);
                        $('#sma_short_window').text(response.sma_short_window);
                        $('#sma_long_window').text(response.sma_long_window);
                        $('#investment-data').show();
                    
                        const plots = response.plots;
                        if (plots) {
                            $('#plots').empty();
                            Object.keys(plots).forEach(plot => {
                                $('#plots').append(`<div id="${plot}" class="plot"></div>`);
                                Plotly.newPlot(plot, JSON.parse(plots[plot]), { responsive: true });
                            });
                        } else {
                            console.error("No plot data available");
                        }
                        
                    },
                    error: function(error) {
                        var errorMessage = 'An unknown error occurred';
                        if (error.responseJSON && error.responseJSON.message) {
                            errorMessage = error.responseJSON.message;
                        }
                        alert('Error: ' + errorMessage);
                    },
                    complete: function() {
                        $('#loading-indicator').hide();
                    }
                });
            });
        });
    </script>
</body>
</html>
